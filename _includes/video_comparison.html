<!-- _includes/video_comparison.html -->
{% assign left_video = include.left_video %}
{% assign right_video = include.right_video %}
{% assign left_label = include.left_label | default: "Before" %}
{% assign right_label = include.right_label | default: "After" %}
{% assign height = include.height | default: 400 %}
{% assign autoplay = include.autoplay | default: true %}

<div class="video-comparison-container" style="position: relative; width: 100%; height: {{ height }}px; margin: 20px 0; overflow: hidden; border-radius: 8px; background: #000;">
  <!-- 左侧视频 - 固定位置，使用拉伸填充 -->
  <div class="video-wrapper video-left" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1;">
    <video width="100%" height="100%" 
           {% if autoplay %}autoplay{% endif %} 
           muted 
           loop 
           playsinline
           style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: fill;">
      <source src="{{ left_video }}" type="video/mp4">
      您的浏览器不支持 video 标签。
    </video>
    <div class="video-label" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 14px; z-index: 3;">
      {{ left_label }}
    </div>
  </div>
  
  <!-- 右侧视频 - 固定位置，使用拉伸填充 -->
  <div class="video-wrapper video-right" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 2; clip-path: inset(0 0 0 50%);">
    <video width="100%" height="100%" 
           {% if autoplay %}autoplay{% endif %} 
           muted 
           loop 
           playsinline
           style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: fill;">
      <source src="{{ right_video }}" type="video/mp4">
      您的浏览器不支持 video 标签。
    </video>
    <div class="video-label" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 14px; z-index: 3;">
      {{ right_label }}
    </div>
  </div>
  
  <!-- 滑块 -->
  <div class="slider" 
       style="position: absolute; top: 0; left: 50%; width: 4px; height: 100%; background: white; cursor: ew-resize; transform: translateX(-50%); box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 10;"
       onmousedown="startDrag(event, this)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 8px; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
      ↔
    </div>
  </div>
</div>

<script>
function startDrag(e, slider) {
  e.preventDefault();
  e.stopPropagation();
  
  const container = slider.parentElement;
  const rightVideoWrapper = container.querySelector('.video-right');
  
  // 确保视频播放
  const videos = container.querySelectorAll('video');
  videos.forEach(video => {
    if (video.paused) video.play().catch(e => console.log("视频自动播放被阻止"));
  });
  
  const containerRect = container.getBoundingClientRect();
  const initialX = e.clientX;
  const initialPercentage = parseFloat(slider.style.left || '50');
  
  function handleMove(moveEvent) {
    moveEvent.preventDefault();
    
    // 计算滑块移动的距离
    const deltaX = moveEvent.clientX - initialX;
    
    // 计算新的百分比
    const deltaPercentage = (deltaX / containerRect.width) * 100;
    const newPercentage = Math.max(0, Math.min(100, initialPercentage + deltaPercentage));
    
    // 更新右侧视频的裁剪区域
    rightVideoWrapper.style.clipPath = `inset(0 0 0 ${newPercentage}%)`;
    
    // 更新滑块位置
    slider.style.left = `${newPercentage}%`;
  }
  
  function handleUp(upEvent) {
    upEvent.preventDefault();
    
    // 移除事件监听器
    document.removeEventListener('mousemove', handleMove);
    document.removeEventListener('mouseup', handleUp);
    
    // 恢复文本选择
    document.body.style.userSelect = '';
  }
  
  // 添加事件监听器
  document.addEventListener('mousemove', handleMove);
  document.addEventListener('mouseup', handleUp);
  
  // 阻止文本选择
  document.body.style.userSelect = 'none';
}

// 添加触摸事件支持
document.addEventListener('touchstart', function(e) {
  if (e.target.classList.contains('slider') || e.target.parentElement.classList.contains('slider')) {
    startDrag(e, e.target.classList.contains('slider') ? e.target : e.target.parentElement);
  }
});

// 视频加载后确保尺寸正确
document.addEventListener('DOMContentLoaded', function() {
  const videos = document.querySelectorAll('.video-comparison-container video');
  videos.forEach(video => {
    video.addEventListener('loadeddata', function() {
      // 强制视频填充容器，不保持宽高比
      this.style.objectFit = 'fill';
    });
  });
});
</script>

<style>
/* 确保视频填充容器，不裁剪 */
.video-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.video-wrapper video {
  width: 100%;
  height: 100%;
  object-fit: fill; /* 使用fill而不是cover，确保拉伸填充不裁剪 */
  position: absolute;
  top: 0;
  left: 0;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .video-comparison-container {
    height: 300px !important;
  }
}
</style>