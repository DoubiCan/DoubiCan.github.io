<!-- _includes/video_comparison.html -->
{% assign left_video = include.left_video %}
{% assign right_video = include.right_video %}
{% assign left_label = include.left_label | default: "Before" %}
{% assign right_label = include.right_label | default: "After" %}
{% assign height = include.height | default: 400 %}
{% assign autoplay = include.autoplay | default: true %}

<div class="video-comparison-container" style="position: relative; width: 100%; height: {{ height }}px; margin: 20px 0; overflow: hidden; border-radius: 8px; background: #000;">
  <!-- 左侧视频 - 始终覆盖整个容器 -->
  <div class="video-wrapper video-left" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1;">
    <video width="100%" height="100%" 
           {% if autoplay %}autoplay{% endif %} 
           muted 
           loop 
           playsinline
           style="object-fit: cover; width: 100%; height: 100%;">
      <source src="{{ left_video }}" type="video/mp4">
      您的浏览器不支持 video 标签。
    </video>
    <div class="video-label" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 14px; z-index: 3;">
      {{ left_label }}
    </div>
  </div>
  
  <!-- 右侧视频 - 也覆盖整个容器，通过clip-path控制显示区域 -->
  <div class="video-wrapper video-right" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 2; clip-path: inset(0 0 0 50%);">
    <video width="100%" height="100%" 
           {% if autoplay %}autoplay{% endif %} 
           muted 
           loop 
           playsinline
           style="object-fit: cover; width: 100%; height: 100%;">
      <source src="{{ right_video }}" type="video/mp4">
      您的浏览器不支持 video 标签。
    </video>
    <div class="video-label" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 3px; font-size: 14px; z-index: 3;">
      {{ right_label }}
    </div>
  </div>
  
  <!-- 滑块 -->
  <div class="slider" 
       style="position: absolute; top: 0; left: 50%; width: 4px; height: 100%; background: white; cursor: ew-resize; transform: translateX(-50%); box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 10;"
       onmousedown="startDrag(event, this)">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; padding: 8px; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 18px;">
      ↔
    </div>
  </div>
</div>

<script>
function startDrag(e, slider) {
  e.preventDefault();
  e.stopPropagation();
  
  const container = slider.parentElement;
  const leftVideoWrapper = container.querySelector('.video-left');
  const rightVideoWrapper = container.querySelector('.video-right');
  const leftVideo = leftVideoWrapper.querySelector('video');
  const rightVideo = rightVideoWrapper.querySelector('video');
  
  // 确保视频播放
  if (leftVideo.paused) leftVideo.play().catch(e => console.log("视频自动播放被阻止"));
  if (rightVideo.paused) rightVideo.play().catch(e => console.log("视频自动播放被阻止"));
  
  const containerRect = container.getBoundingClientRect();
  
  function handleMove(moveEvent) {
    moveEvent.preventDefault();
    
    // 计算滑块位置（相对于容器）
    let x = moveEvent.clientX - containerRect.left;
    
    // 限制在容器范围内
    x = Math.max(0, Math.min(x, containerRect.width));
    
    // 计算百分比
    const percentage = (x / containerRect.width) * 100;
    
    // 更新右侧视频的裁剪区域
    // 当滑块在0%时，右侧视频完全显示（clip-path: inset(0 0 0 0%)）
    // 当滑块在100%时，右侧视频完全隐藏（clip-path: inset(0 0 0 100%)）
    rightVideoWrapper.style.clipPath = `inset(0 0 0 ${percentage}%)`;
    
    // 更新滑块位置
    slider.style.left = `${percentage}%`;
  }
  
  function handleUp(upEvent) {
    upEvent.preventDefault();
    
    // 移除事件监听器
    document.removeEventListener('mousemove', handleMove);
    document.removeEventListener('mouseup', handleUp);
    
    // 恢复文本选择
    document.body.style.userSelect = '';
  }
  
  // 添加事件监听器
  document.addEventListener('mousemove', handleMove);
  document.addEventListener('mouseup', handleUp);
  
  // 阻止文本选择
  document.body.style.userSelect = 'none';
}

// 添加触摸事件支持
document.addEventListener('touchstart', function(e) {
  if (e.target.classList.contains('slider')) {
    startDrag(e, e.target);
  }
});
</script>

<style>
/* 确保视频播放控制 */
.video-wrapper video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .video-comparison-container {
    height: 300px !important;
  }
}
</style>